<!-- templates/bookings/checkout.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Pathan Travels</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> {% if razorpay_enabled %}
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    {% endif %}

    <style>
        body {
            background: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        
        .payment-box {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn-pay {
            background: #198754;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-simulate {
            background: #6c757d;
            color: white;
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            width: 100%;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="payment-box">
            <div class="text-center mb-4">
                {% if razorpay_enabled %}
                <h2>üí∞ Pay Booking Advance</h2>
                <p class="text-muted">Secure payment via Razorpay</p>
                {% else %}
                <h2>‚ö†Ô∏è Payment Simulation</h2>
                <p class="text-muted">Payment gateway not configured</p>
                {% endif %}
            </div>

            <!-- Booking Details -->
            <div class="alert alert-info mb-4">
                <h5 class="alert-heading">Booking Details</h5>
                <hr>
                <p class="mb-1"><strong>Name:</strong> {{ booking.name }}</p>
                <p class="mb-1"><strong>Route:</strong> {{ booking.pickup }} ‚Üí {{ booking.drop }}</p>
                <p class="mb-1"><strong>Distance:</strong> {{ booking.distance_km }} KM</p>
                <p class="mb-0"><strong>Total Fare:</strong> ‚Çπ{{ booking.total_price }}</p>
            </div>

            <!-- Amount -->
            <div class="text-center mb-4">
                <h4>Advance Amount: <span class="text-success">‚Çπ1000</span></h4>
                <p class="text-muted">(Remaining: ‚Çπ{{ booking.remaining_amount }})</p>
            </div>

            <!-- Payment Methods -->
            {% if razorpay_enabled %}
            <!-- Real Razorpay Payment -->
            <button id="rzp-button" class="btn btn-pay">
                    Pay ‚Çπ1000 Now
                </button>

            <!-- Simulation Option -->
            <form method="POST" action="{% url 'payment_success' %}">
                {% csrf_token %}
                <input type="hidden" name="razorpay_payment_id" value="sim_pay_{{ booking.id }}_{{ booking.created_at.timestamp }}">
                <input type="hidden" name="razorpay_order_id" value="{{ payment.id }}">
                <input type="hidden" name="razorpay_signature" value="sim_sig_{{ booking.id }}">

                <button type="submit" class="btn btn-simulate">
                        Simulate Payment Instead
                    </button>
            </form>

            {% else %}
            <!-- Simulation Only -->
            <div class="alert alert-warning mb-4">
                <p class="mb-0">Payment gateway is not configured. Using simulation mode.</p>
            </div>

            <form method="POST" action="{% url 'payment_success' %}">
                {% csrf_token %}
                <input type="hidden" name="razorpay_payment_id" value="sim_pay_{{ booking.id }}_{{ booking.created_at.timestamp }}">
                <input type="hidden" name="razorpay_order_id" value="sim_order_{{ booking.id }}">
                <input type="hidden" name="razorpay_signature" value="sim_sig_{{ booking.id }}">

                <button type="submit" class="btn btn-simulate">
                        Confirm Booking (Simulation)
                    </button>
            </form>
            {% endif %}

            <!-- Cancel Button -->
            <div class="mt-4 text-center">
                <a href="{% url 'book_trip' %}" class="btn btn-outline-secondary">Cancel Booking</a>
            </div>
        </div>
    </div>

    <!-- Razorpay Script (only if enabled) -->
    {% if razorpay_enabled %}
    <script>
        var options = {
            "key": "{{ razorpay_key_id }}",
            "amount": "100000", // ‚Çπ1000 in paise
            "currency": "INR",
            "name": "Pathan Travels",
            "description": "Booking Advance Payment",
            "order_id": "{{ payment.id }}",
            "handler": function(response) {
                // Create form and submit
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = "{% url 'payment_success' %}";

                var csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = '{{ csrf_token }}';
                form.appendChild(csrf);

                var paymentId = document.createElement('input');
                paymentId.type = 'hidden';
                paymentId.name = 'razorpay_payment_id';
                paymentId.value = response.razorpay_payment_id;
                form.appendChild(paymentId);

                var orderId = document.createElement('input');
                orderId.type = 'hidden';
                orderId.name = 'razorpay_order_id';
                orderId.value = response.razorpay_order_id;
                form.appendChild(orderId);

                var signature = document.createElement('input');
                signature.type = 'hidden';
                signature.name = 'razorpay_signature';
                signature.value = response.razorpay_signature;
                form.appendChild(signature);

                document.body.appendChild(form);
                form.submit();
            },
            "prefill": {
                "name": "{{ booking.name }}",
                "contact": "{{ booking.phone }}",
                "email": "{{ booking.email|default:'customer@example.com' }}"
            },
            "theme": {
                "color": "#198754"
            },
            "modal": {
                "ondismiss": function() {
                    // Optional: Handle modal dismissal
                    console.log("Payment modal dismissed");
                }
            }
        };

        var rzp1 = new Razorpay(options);

        document.getElementById('rzp-button').onclick = function(e) {
            rzp1.open();
            e.preventDefault();
        }
    </script>
    {% endif %}
</body>

</html>